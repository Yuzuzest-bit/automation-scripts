#!/usr/bin/env bash
set -uo pipefail

# ------------------------------------------------------------
# zk_sync_due_primitive.sh
# 正規表現による行マッチをやめ、強制抽出を行う確実版
# ------------------------------------------------------------

# 文字コード設定（Windows GitBash用）
export LANG=ja_JP.UTF-8

PARENT_FILE="${1:-}"

if [[ -z "$PARENT_FILE" || ! -f "$PARENT_FILE" ]]; then
  echo "[ERR] Parent file not found: $PARENT_FILE"
  echo "Usage: $0 <dashboard_file> [search_root_dir]"
  exit 1
fi

# 検索ルートの設定
DEFAULT_ROOT="$(cd "$(dirname "$PARENT_FILE")/.." && pwd)"
SEARCH_ROOT="${2:-$DEFAULT_ROOT}"

if [[ ! -d "$SEARCH_ROOT" ]]; then
  echo "[ERR] Search directory not found: $SEARCH_ROOT"
  exit 1
fi

echo "[INFO] Indexing files in: $SEARCH_ROOT ..."

# --- 1. 高速化のためのファイルマッピング ---
declare -A FILE_MAP
while IFS= read -r FILE_PATH; do
  BASENAME=$(basename "$FILE_PATH" .md)
  FILE_MAP["$BASENAME"]="$FILE_PATH"
done < <(find "$SEARCH_ROOT" -name "*.md")

echo "[INFO] Indexing complete. Syncing due dates..."

# --- 2. 「due:」が含まれる行だけを単純検索（正規表現を使わない） ---
# grep -F: 文字列として単純検索（絵文字による正規表現エラーを回避）
TARGET_LINES=$(grep -F "due:" "$PARENT_FILE" || true)

if [[ -z "$TARGET_LINES" ]]; then
  echo "[WARN] No lines with 'due:' found in $PARENT_FILE."
  exit 0
fi

count=0

# 改行区切りでループ
IFS=$'\n'
for LINE in $TARGET_LINES; do
  # Windows改行コード除去
  LINE=$(echo "$LINE" | tr -d '\r')

  # --- 3. データの「くり抜き」処理 ---
  # 行全体の構造（間に何があるか）は気にせず、欲しい部分だけを grep -o で切り出す
  
  # リンク: [[...]] という形の部分だけを抜き出す
  LINK_PART=$(echo "$LINE" | grep -o '\[\[[^]]*\]\]' | head -n 1)
  # [[ と ]] を削除
  LINK="${LINK_PART//[\[\]]/}"

  # 日付: due: YYYY-MM-DD という形の部分だけを抜き出す
  # [0-9]\{4\} はWindows GitBashのgrepでも確実に動く基本正規表現
  DUE_PART=$(echo "$LINE" | grep -o 'due: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' | head -n 1)
  # due: を削除して日付のみにする
  DUE_DATE="${DUE_PART#due: }"

  # 抽出失敗ならスキップ
  if [[ -z "$LINK" || -z "$DUE_DATE" ]]; then
    continue
  fi

  # --- 4. ファイル特定と更新 ---
  FILE_PATH="${FILE_MAP[$LINK]:-}"

  if [[ -z "$FILE_PATH" ]]; then
    continue
  fi

  # awk で Frontmatter を安全に書き換え
  TMP_FILE=$(mktemp)
  awk -v due_val="due: $DUE_DATE" '
    BEGIN { inFM=0; fmDone=0; dueSet=0 }
    /^---$/ && inFM==0 && fmDone==0 { inFM=1; print; next }
    inFM==1 {
      if ($0 ~ /^due:[[:space:]]*/) {
        print due_val; dueSet=1; next
      }
      if ($0 ~ /^---$/) {
        if (dueSet==0) print due_val
        inFM=0; fmDone=1; print; next
      }
    }
    { print }
  ' "$FILE_PATH" > "$TMP_FILE"

  mv "$TMP_FILE" "$FILE_PATH"
  echo "[SYNCED] $LINK -> $DUE_DATE"
  count=$((count + 1))
done

echo "----------------------------------------"
if [[ $count -eq 0 ]]; then
  echo "[WARN] 更新対象が見つかりませんでした。"
  echo "       考えられる原因: due: の後ろに正しい日付(YYYY-MM-DD)がない、または [[リンク]] が読み取れていない。"
else
  echo "完了！ $count 件のノートに期限を反映しました。"
fi
